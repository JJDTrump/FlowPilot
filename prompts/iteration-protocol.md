# 迭代协议

## 强制纪律（MANDATORY）

1. **感知先行**: 每一步开始前，必须先执行 `flow status` 获取完整上下文注入
2. **及时推进**: 每一步完成后，必须立即执行 `flow advance --note "..."` 记录产物
3. **禁止积压**: 不得连续执行多个原子操作而不更新工作流状态
4. **禁止绕过**: 所有操作必须通过 workflow 工具执行，禁止直接操作
5. **任务树只读**: 任务树由系统派生，不得直接修改
6. **上下文恢复**: 上下文压缩/会话恢复后，必须先执行 `flow status` 确认当前状态再继续
7. **前置感知**: 执行任务前，先查看目标中的依赖字段，读取相关文件确认上下文
8. **状态文档同步**: 迭代完成前，必须更新项目状态文档（如 STATUS.md），确保文档反映代码实际状态

>>> 违反任何一条纪律，当前步骤视为无效，必须回退重做。

## 单步执行流程

```
flow status        → 接收约束与上下文（必须）
执行原子操作        → 仅执行当前步骤要求的操作（禁止超范围）
flow advance       → 记录产物，推进到下一步（必须附 --note）
```

>>> 每一步的 advance --note 必须包含：做了什么、产物路径、是否符合预期。

## 迭代流程

```
调查 → 领域建模 → 规划 → TDD 实现 → 严格审计 → 验收
```

### TDD 实现阶段

```
Red    → 先写一个会失败的测试，明确期望行为
Green  → 写最少的代码让测试通过
Refactor → 在测试保护下优化代码结构
```

>>> 禁止跳过 Red 阶段直接写实现。测试必须先失败，证明测试本身有效。

### 审计阶段

每个实现步骤完成后必须立即审计，不可积压。

| 维度 | 检查内容 |
|------|---------|
| 安全 | OWASP Top 10、输入验证、权限控制 |
| DDD 合规 | 分层纯净、聚合边界正确、领域逻辑无泄漏 |
| TDD 合规 | 测试先行、覆盖维度完整、mock 边界正确 |
| 代码质量 | 命名规范、职责单一、无死代码 |

### 验收阶段

- plan 第 N 步 → report 第 N 步结果，一一对应
- 偏差必须说明原因
- 所有测试必须通过：`pnpm run test`

## 工作流命令速查

```bash
flow create <name>    # 创建工作流 (stdin 读取 markdown)
flow start <name>     # 启动工作流
flow advance          # 推进当前步骤 [--note "..."] [--artifact path]
flow branch <choice>  # 选择分支路径
flow spawn            # 派生子工作流 (stdin 读取 markdown)
flow return <parent>  # 返回父工作流
flow status [name]    # 查看当前状态与上下文注入
flow list             # 列出所有工作流
flow edit <name>      # 更新工作流 (stdin 读取 markdown)
flow caps             # 列出原子能力清单
flow init-context     # 扫描 docs/ 生成 .workflow/context.json
```

## 粒度判断

计划每步都是原子操作（单次工具调用）？是 → 执行。否 → 拆分为子工作流。

## 常见违规与纠正

| 违规 | 后果 | 纠正 |
|------|------|------|
| 跳过 `flow status` 直接开始 | 缺失上下文，可能重复或遗漏 | 立即执行 `flow status` |
| 连续多步不 advance | 状态丢失，无法追溯 | 补充 advance 并记录偏差 |
| advance 不写 note | 产物不可追溯 | 重新 advance 附带完整 note |
| 实现后不审计 | 质量债务积压 | 停止推进，先完成审计 |
| 直接修改工作流文件 | 状态不一致 | 通过 flow edit 重新定义 |
